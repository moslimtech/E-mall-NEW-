// 1. دوال المستخدمين
function registerUser(email, password, name, phone, placeId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("المستخدمين");
  
  // التحقق من عدم تكرار الإيميل
  const emails = sheet.getRange("A2:A").getValues().flat();
  if (emails.includes(email)) throw new Error("الإيميل مسجل مسبقًا");

  // تسجيل المستخدم
  sheet.appendRow([
    email,
    Utilities.base64Encode(password),
    Utilities.getUuid(), // معرف المستخدم
    placeId,
    name,
    phone
  ]);

  return { success: true, userId: email };
}

function loginUser(email, password) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("المستخدمين");
  const data = sheet.getDataRange().getValues();
  
  const user = data.find(row => row[0] === email);
  if (!user) throw new Error("الإيميل غير مسجل");
  
  if (user[1] !== Utilities.base64Encode(password)) {
    throw new Error("كلمة المرور غير صحيحة");
  }
  
  return {
    userId: user[2],
    placeId: user[3],
    name: user[4]
  };
}

// 2. إدارة المحلات
function getPlaceInfo(placeId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("معلومات المكان");
  const data = sheet.getDataRange().getValues();
  
  const place = data.find(row => row[0] === placeId);
  if (!place) throw new Error("المكان غير موجود");
  
  return {
    name: place[1],
    city: place[3],
    area: place[11],
    location: place[9],
    logo: place[13],
    status: place[15] // حالة المكان
  };
}

// 3. نظام الدفع
function requestPayment(userId, packageName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const paymentsSheet = ss.getSheetByName("الدفعات");
  const packagesSheet = ss.getSheetByName("الباقات");
  
  const packageData = packagesSheet.getDataRange().getValues()
    .find(row => row[0] === packageName);
  if (!packageData) throw new Error("الباقة غير موجودة");
  
  const paymentId = Utilities.getUuid().slice(0, 8);
  paymentsSheet.appendRow([
    paymentId,
    "", // رقم الهاتف (يُملأ لاحقًا)
    packageData[1], // السعر
    "", // رقم التحويل
    "قيد الانتظار",
    new Date(),
    userId
  ]);
  
  return {
    paymentId: paymentId,
    amount: packageData[1],
    instructions: `قم بالتحويل لرقم 0123456789 بالمبلغ ${packageData[1]} جنيه`
  };
}

// 4. الواجهة البرمجية الرئيسية
function doPost(e) {
  try {
    const request = JSON.parse(e.postData.contents);
    let response;
    
    switch (request.action) {
      case "register":
        response = registerUser(request.email, request.password, request.name, request.phone, request.placeId);
        break;
      case "login":
        response = loginUser(request.email, request.password);
        break;
      case "getPlaceInfo":
        response = getPlaceInfo(request.placeId);
        break;
      case "requestPayment":
        response = requestPayment(request.userId, request.packageName);
        break;
      default:
        throw new Error("Action not supported");
    }
    
    return ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ 
      error: error.message 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
