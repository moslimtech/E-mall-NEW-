<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تسجيل محل</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="register-box">
    <h2>تسجيل محل جديد</h2>

    <input type="text" id="store-name" placeholder="اسم المحل">
    <select id="store-category"><option>تحميل...</option></select>
    <select id="store-city" onchange="loadRegions()"><option>تحميل...</option></select>
    <select id="store-region"><option>تحميل...</option></select>
    <input type="text" id="store-phone" placeholder="رقم التواصل">
    <input type="text" id="store-whatsapp" placeholder="رابط واتساب">
    <input type="email" id="store-email" placeholder="البريد الإلكتروني">
    <input type="text" id="store-location" placeholder="الموقع الجغرافي">
    <button onclick="getCurrentLocation()">📍 تحديد موقعي</button>
    <select id="store-floor"><option>تحميل...</option></select>
    <select id="store-status"><option>تحميل...</option></select>
    <select id="store-delivery"><option>تحميل...</option></select>
    <input type="file" id="store-logo" accept="image/*">
    <button onclick="registerStore()">تسجيل</button>

    <div id="result"></div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbwcyqY4HfjGUGLAtslLd3m-bXh3pBNz6TsuWpjCXpJpJBzL_ElbaGCi-pjOiISSXKXtkg/exec/exec';

    window.onload = () => {
      loadSelect("getCategories", "store-category", "معرف نوع النشاط", "اسم نوع النشاط");
      loadSelect("getCities", "store-city", "IDالمدينة", "المدينة");
      loadSelect("getFloors", "store-floor", "الدور", "الدور");
      loadSelect("getStatuses", "store-status", "حالة المكان", "حالة المكان");
      loadSelect("getDeliveryOptions", "store-delivery", "التوصيل", "التوصيل");
    };

    function loadSelect(action, id, valueKey, textKey) {
      fetch(`${API}?action=${action}`)
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById(id);
          select.innerHTML = '<option value="">اختر</option>';
          data.forEach(item => {
            select.innerHTML += `<option value="${item[valueKey]}">${item[textKey]}</option>`;
          });
        });
    }

    function loadRegions() {
      const cityId = document.getElementById("store-city").value;
      const select = document.getElementById("store-region");
      select.innerHTML = '<option>تحميل...</option>';
      fetch(`${API}?action=getRegions&cityId=${cityId}`)
        .then(res => res.json())
        .then(data => {
          select.innerHTML = '<option value="">اختر المنطقة</option>';
          data.forEach(item => {
            select.innerHTML += `<option value="${item["IDالمنطقة"]}">${item["المنطقة"]}</option>`;
          });
        });
    }

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById("store-location").value = `${pos.coords.latitude},${pos.coords.longitude}`;
      }, err => alert("تعذر تحديد الموقع"));
    }

    async function registerStore() {
      const logoInput = document.getElementById("store-logo");
      const file = logoInput.files[0];
      let logoPath = '';

      if (file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        await new Promise(resolve => reader.onloadend = resolve);
        const base64 = reader.result.split(',')[1];

        const form = new FormData();
        form.append("image", base64);
        form.append("storeId", crypto.randomUUID());

        const uploadRes = await fetch(API, {
          method: "POST",
          body: form
        });
        const uploadData = await uploadRes.json();
        if (uploadData.status === "success") {
          logoPath = uploadData.path;
        } else {
          document.getElementById("result").innerText = "❌ فشل رفع الصورة.";
          return;
        }
      }

      const data = {
        action: "registerStore",
        اسم_المكان: document.getElementById("store-name").value,
        معرف_نوع_النشاط: document.getElementById("store-category").value,
        المدينة: document.getElementById("store-city").value,
        المنطقة: document.getElementById("store-region").value,
        رقم_التواصل: document.getElementById("store-phone").value,
        رابط_واتساب: document.getElementById("store-whatsapp").value,
        الإيميل: document.getElementById("store-email").value,
        الموقع: document.getElementById("store-location").value,
        الدور: document.getElementById("store-floor").value,
        حالة_المكان_الان: document.getElementById("store-status").value,
        يوجد_خدمة_توصيل: document.getElementById("store-delivery").value,
        صورة_شعار_المكان: logoPath
      };

      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (result.status === "success") {
        document.getElementById("result").innerText = "✅ تم التسجيل بنجاح.";
      } else {
        document.getElementById("result").innerText = "❌ حدث خطأ أثناء التسجيل.";
      }
    }
  </script>
</body>
</html>
