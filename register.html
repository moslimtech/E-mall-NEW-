<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="register-box">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯</h2>

    <input type="text" id="store-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„">
    <select id="store-category"><option>ØªØ­Ù…ÙŠÙ„...</option></select>
    <select id="store-city" onchange="loadRegions()"><option>ØªØ­Ù…ÙŠÙ„...</option></select>
    <select id="store-region"><option>ØªØ­Ù…ÙŠÙ„...</option></select>
    <input type="text" id="store-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„">
    <input type="text" id="store-whatsapp" placeholder="Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨">
    <input type="email" id="store-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="text" id="store-location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ">
    <button onclick="getCurrentLocation()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    <select id="store-floor"><option>ØªØ­Ù…ÙŠÙ„...</option></select>
    <select id="store-status"><option>ØªØ­Ù…ÙŠÙ„...</option></select>
    <select id="store-delivery"><option>ØªØ­Ù…ÙŠÙ„...</option></select>
    <input type="file" id="store-logo" accept="image/*">
    <button onclick="registerStore()">ØªØ³Ø¬ÙŠÙ„</button>

    <div id="result"></div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbwcyqY4HfjGUGLAtslLd3m-bXh3pBNz6TsuWpjCXpJpJBzL_ElbaGCi-pjOiISSXKXtkg/exec/exec';

    window.onload = () => {
      loadSelect("getCategories", "store-category", "Ù…Ø¹Ø±Ù Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·", "Ø§Ø³Ù… Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·");
      loadSelect("getCities", "store-city", "IDØ§Ù„Ù…Ø¯ÙŠÙ†Ø©", "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©");
      loadSelect("getFloors", "store-floor", "Ø§Ù„Ø¯ÙˆØ±", "Ø§Ù„Ø¯ÙˆØ±");
      loadSelect("getStatuses", "store-status", "Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§Ù†", "Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§Ù†");
      loadSelect("getDeliveryOptions", "store-delivery", "Ø§Ù„ØªÙˆØµÙŠÙ„", "Ø§Ù„ØªÙˆØµÙŠÙ„");
    };

    function loadSelect(action, id, valueKey, textKey) {
      fetch(`${API}?action=${action}`)
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById(id);
          select.innerHTML = '<option value="">Ø§Ø®ØªØ±</option>';
          data.forEach(item => {
            select.innerHTML += `<option value="${item[valueKey]}">${item[textKey]}</option>`;
          });
        });
    }

    function loadRegions() {
      const cityId = document.getElementById("store-city").value;
      const select = document.getElementById("store-region");
      select.innerHTML = '<option>ØªØ­Ù…ÙŠÙ„...</option>';
      fetch(`${API}?action=getRegions&cityId=${cityId}`)
        .then(res => res.json())
        .then(data => {
          select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>';
          data.forEach(item => {
            select.innerHTML += `<option value="${item["IDØ§Ù„Ù…Ù†Ø·Ù‚Ø©"]}">${item["Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"]}</option>`;
          });
        });
    }

    function getCurrentLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById("store-location").value = `${pos.coords.latitude},${pos.coords.longitude}`;
      }, err => alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"));
    }

    async function registerStore() {
      const logoInput = document.getElementById("store-logo");
      const file = logoInput.files[0];
      let logoPath = '';

      if (file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        await new Promise(resolve => reader.onloadend = resolve);
        const base64 = reader.result.split(',')[1];

        const form = new FormData();
        form.append("image", base64);
        form.append("storeId", crypto.randomUUID());

        const uploadRes = await fetch(API, {
          method: "POST",
          body: form
        });
        const uploadData = await uploadRes.json();
        if (uploadData.status === "success") {
          logoPath = uploadData.path;
        } else {
          document.getElementById("result").innerText = "âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©.";
          return;
        }
      }

      const data = {
        action: "registerStore",
        Ø§Ø³Ù…_Ø§Ù„Ù…ÙƒØ§Ù†: document.getElementById("store-name").value,
        Ù…Ø¹Ø±Ù_Ù†ÙˆØ¹_Ø§Ù„Ù†Ø´Ø§Ø·: document.getElementById("store-category").value,
        Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: document.getElementById("store-city").value,
        Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: document.getElementById("store-region").value,
        Ø±Ù‚Ù…_Ø§Ù„ØªÙˆØ§ØµÙ„: document.getElementById("store-phone").value,
        Ø±Ø§Ø¨Ø·_ÙˆØ§ØªØ³Ø§Ø¨: document.getElementById("store-whatsapp").value,
        Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: document.getElementById("store-email").value,
        Ø§Ù„Ù…ÙˆÙ‚Ø¹: document.getElementById("store-location").value,
        Ø§Ù„Ø¯ÙˆØ±: document.getElementById("store-floor").value,
        Ø­Ø§Ù„Ø©_Ø§Ù„Ù…ÙƒØ§Ù†_Ø§Ù„Ø§Ù†: document.getElementById("store-status").value,
        ÙŠÙˆØ¬Ø¯_Ø®Ø¯Ù…Ø©_ØªÙˆØµÙŠÙ„: document.getElementById("store-delivery").value,
        ØµÙˆØ±Ø©_Ø´Ø¹Ø§Ø±_Ø§Ù„Ù…ÙƒØ§Ù†: logoPath
      };

      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (result.status === "success") {
        document.getElementById("result").innerText = "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.";
      } else {
        document.getElementById("result").innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.";
      }
    }
  </script>
</body>
</html>
